
# How To Create A Simple Subnet In `C#`

This is a step by step guide on how to start creating a subnet using C#. The end result is a _working but incomplete_ subnet VM running on a local network.

It is a C# implementation of this language-agnostic guide about [how to create a subnet from scratch](https://boulixavalanchedocs.web.app/subnets/create-a-simple-vm-from-scratch).

At the end of each chapter, you will find the link to a branch representing the current implementation.

## Pre-Requisites

This is for C# developers with little or no blockchain knowledge. This guide is assuming you are using linux, but it can probably work just as well on a mac, or on windows using WSL2.

- [dotnet](https://dotnet.microsoft.com/en-us/download/dotnet) :
  You must follow the instructions to install .net, you will be required to use the `dotnet` cli.

- [avalanchego](https://github.com/ava-labs/avalanchego/releases) :
  Extract the latest release in your ~/bin folder

- [avalanche-network-runner](https://github.com/ava-labs/avalanche-network-runner/releases) :
  Extract the latest release in your ~/bin folder

## Project Initialization

```sh
dotnet new grpc -n MySubnet
```

This will create a new project named MySubnet using the [dotnet grpc template](https://learn.microsoft.com/en-us/aspnet/core/tutorials/grpc/grpc-start?view=aspnetcore-7.0&tabs=visual-studio-code).

This project is a basic ASP.NET Core gRPC Server, with an example GreeterService built from the greet.proto file. We will remove these as we clean-up.

### Add Avalanche Proto Files

We will reference the proto files using `dotnet-grpc` instead of using `buf`, because it is so well integrated into .net tooling.

Install dotnet-grpc tool in your project

```sh
dotnet new tool-manifest
dotnet tool install dotnet-grpc
```

Open the `src/MySubnet/MySubnet.csproj`, and add the following `ItemGroup` to add the minimum required proto references.

```xml
  <ItemGroup>
    <Protobuf Include="../protos/io/prometheus/client/metrics.proto" Link="Protos/metrics.proto" GrpcServices="None">
      <SourceUrl>
        https://raw.githubusercontent.com/prometheus/client_model/master/io/prometheus/client/metrics.proto</SourceUrl>
    </Protobuf>
    <Protobuf Include="../protos/vm.proto" Link="Protos/vm.proto" GrpcServices="Server">
      <SourceUrl>https://raw.githubusercontent.com/ava-labs/avalanchego/master/proto/vm/vm.proto</SourceUrl>
    </Protobuf>    
    <Protobuf Include="../protos/runtime.proto" Link="Protos/runtime.proto" GrpcServices="Client">
      <SourceUrl>
        https://raw.githubusercontent.com/ava-labs/avalanchego/master/proto/vm/runtime/runtime.proto
      </SourceUrl>
    </Protobuf>    
  </ItemGroup>
```

Download the references and build your project

```sh
dotnet dotnet-grpc refresh
dotnet build
```

### Cleanup

- Delete all unnecessary files that were generated by the `dotnet grpc template` :
  - settings files : `appsettings.*`
  - folders : `Service`, `Properties` and `Protos`
- In `Program.cs`, remove the GreeterService registration `app.MapGrpcService<GreeterService>();`.
- In `MySubnet.csproj`, remove the block containing the reference to the greet.proto file `<Protobuf Include="Protos\greet.proto" GrpcServices="Server" />`.

### Empty proto implementations

Create a folder named Avalanche which will contain the needed classes for communication between our VM and AvalancheGo. In this folder, create these two classes  :

- `RuntimeClient.cs` is used to call AvalancheGo's runtime service. It uses the `RuntimeClient` class generated from the `runtime.proto` file.

```csharp
namespace MySubnet.Avalanche;
public class RuntimeClient
{
    private Vm.Runtime.Runtime.RuntimeClient _grpcClient;
    public RuntimeClient(Vm.Runtime.Runtime.RuntimeClient grpcClient)
    {
        _grpcClient = grpcClient;
    }
}
```

- `VmServer.cs` is the vm implementation called by AvalancheGo. It inherits the `VMBase` class generated from the `vm.proto` file. This is where we will need to implement the grpc service's methods.

```csharp
namespace MySubnet.Avalanche;
public class VmServer : Vm.VM.VMBase
{
}
```

We now have the basic structure of our project. You can find the source code corresponding to this part in the [project-initialization branch](https://github.com/boulix3/subnet-from-scratch-csharp/tree/project-initialization/src)
